# 批量图片修改功能说明

**功能改进**: 支持同时修改多张图片  
**完成时间**: 2025-11-09  
**修改文件**: `src/nodes.py` - `regenerate_single_image` 节点

---

## 📝 问题描述

**之前的问题**：
- 用户反馈："dolphin 和 shark 单词图片的背景都换成红色的"
- **实际结果**：只修改了 dolphin 这一张图片
- **期望结果**：同时修改 dolphin 和 shark 两张图片

**根本原因**：
1. 节点名称就叫 `regenerate_single_image`，设计时只考虑单张图片
2. LLM 提示词返回格式为单个 `target_image_id`（字符串）
3. 代码逻辑只处理一张图片，处理完就结束

---

## 🔧 解决方案

### 1. 修改 LLM 提示词

**之前**：返回单个图片 ID
```json
{
  "target_image_id": "word_dolphin",
  "modification_summary": "改成蓝色背景",
  "new_prompt": "..."
}
```

**修改后**：返回图片 ID 数组
```json
{
  "modifications": [
    {
      "target_image_id": "word_dolphin",
      "modification_summary": "改成红色背景",
      "new_prompt": "..."
    },
    {
      "target_image_id": "word_shark",
      "modification_summary": "改成红色背景",
      "new_prompt": "..."
    }
  ]
}
```

### 2. 增强 LLM 识别能力

在提示词中添加了关键说明：
- "用户可能要修改一张或多张图片"
- "如果用户说'都'、'全部'、'所有'，可能指多张图片"
- 支持识别 "A 和 B"、"A、B、C" 等列举形式

### 3. 修改代码逻辑

**之前**：处理单张图片
```python
target_id = parsed.get("target_image_id", "")
# ... 处理一张图片
return {"generated_images": updated_images}
```

**修改后**：循环处理多张图片
```python
modifications = parsed.get("modifications", [])
for idx, mod in enumerate(modifications, 1):
    target_id = mod.get("target_image_id", "")
    # ... 处理每张图片
    # ... 更新 updated_images
return {"generated_images": updated_images}
```

### 4. 增强日志输出

新增了详细的批量处理日志：
```
[regenerate_single_image] 识别到 2 张图片需要修改
[regenerate_single_image] [1/2] 目标图片: word_dolphin
[regenerate_single_image] [1/2] 修改要求: 改成红色背景
[regenerate_single_image] [1/2] 开始调用 Gemini Image API...
[regenerate_single_image] [1/2] ✓ 图片重新生成成功: word_dolphin
[regenerate_single_image] [2/2] 目标图片: word_shark
[regenerate_single_image] [2/2] 修改要求: 改成红色背景
[regenerate_single_image] [2/2] 开始调用 Gemini Image API...
[regenerate_single_image] [2/2] ✓ 图片重新生成成功: word_shark
[regenerate_single_image] 总计成功重新生成 2/2 张图片
```

---

## ✅ 改进效果

### 支持的修改场景

1. **单张图片修改**
   ```
   "把 dolphin 的背景改成蓝色"
   ```
   ✅ 只修改 dolphin 这一张

2. **多张图片修改（列举）**
   ```
   "dolphin 和 shark 单词图片的背景都换成红色的"
   ```
   ✅ 修改 dolphin 和 shark 两张

3. **多张图片修改（"都"、"全部"）**
   ```
   "所有单词图片的背景都改成蓝色"
   ```
   ✅ 修改所有匹配的图片

4. **混合修改**
   ```
   "第一个单词图片改成红色，第二个改成蓝色"
   ```
   ✅ LLM 智能识别每张图片的不同要求

### 容错处理

- **部分成功**：如果 3 张图片中只有 2 张成功，会继续处理，最后返回成功的结果
- **全部失败**：记录错误日志，返回空字典（保持原图片不变）
- **信息不完整**：跳过有问题的图片，继续处理其他图片

---

## 🧪 测试建议

### 测试用例 1: 修改两张图片

```
/start 海洋动物
同意
[等待图片和网页生成]
dolphin 和 shark 单词图片的背景都换成红色的
```

**预期结果**：
- ✅ 识别到 2 张图片
- ✅ 两张图片都重新生成
- ✅ 网页中两张图片都更新

### 测试用例 2: 修改所有单词图片

```
所有单词图片的背景都改成蓝色
```

**预期结果**：
- ✅ 识别到所有 word_* 类型的图片（通常 3 张）
- ✅ 所有单词图片都重新生成
- ✅ 句子图片保持不变

### 测试用例 3: 单张图片修改

```
把第一张图片的颜色改得更亮一点
```

**预期结果**：
- ✅ 只识别到 1 张图片
- ✅ 只修改一张图片
- ✅ 其他图片保持不变

---

## 🎯 技术细节

### 关键代码改动

**文件**: `src/nodes.py`  
**函数**: `regenerate_single_image`  
**行号**: 594-750

**主要修改**：

1. **函数文档** (行 596-599)：
   - 更新说明，强调支持多张图片

2. **提示词** (行 641-669)：
   - 修改返回格式为 `modifications` 数组
   - 增加多图片识别的提示

3. **解析逻辑** (行 683-688)：
   - 从 `target_image_id` 改为 `modifications` 数组

4. **处理循环** (行 693-740)：
   - 使用 `for` 循环处理每张图片
   - 增加进度日志 `[1/2]`, `[2/2]`
   - 统计成功/失败数量

### 性能考虑

- **并行优化**：目前是串行处理，未来可以优化为并行生成（需要注意 API 限流）
- **API 调用**：每张图片约 10-15 秒，2 张图片约 20-30 秒
- **用户体验**：通过详细的日志输出，用户可以了解当前进度

---

## 📋 后续优化建议

### 1. 并行图片生成（可选）

如果需要修改多张图片（如 5 张），可以考虑并行调用 API：

```python
import asyncio

async def generate_image_async(prompt, image_id, lesson_id, aspect_ratio):
    # ... 异步调用 API
    
# 并行生成所有图片
results = await asyncio.gather(*[
    generate_image_async(mod["new_prompt"], mod["target_image_id"], ...)
    for mod in modifications
])
```

**优点**：大幅减少等待时间（5 张图片从 50 秒减少到 15 秒）  
**缺点**：需要注意 API 并发限制

### 2. 进度反馈给用户（可选）

在 Telegram Bot 中实时发送进度：

```python
await bot.send_message(
    chat_id=chat_id,
    text=f"正在重新生成第 {idx}/{total} 张图片..."
)
```

### 3. 智能图片缓存（可选）

如果同一个 prompt 已经生成过，可以直接使用缓存，避免重复调用 API。

---

## 🎉 总结

通过这次改进，`regenerate_single_image` 节点现在支持：

✅ **单张图片修改**：保持原有功能  
✅ **批量图片修改**：支持同时修改多张  
✅ **智能识别**：理解 "A 和 B"、"都"、"全部" 等表达  
✅ **详细日志**：清晰的进度和结果反馈  
✅ **容错处理**：部分失败不影响其他图片

节点名称虽然还叫 `regenerate_single_image`，但现在已经是一个真正的"批量图片修改"节点了！

---

**文档版本**: v1.0  
**最后更新**: 2025-11-09
