# å›¾ç‰‡ä¿®æ”¹åŠŸèƒ½è°ƒè¯•æŒ‡å—

**é—®é¢˜**: è¯†åˆ«äº†å›¾ç‰‡ä¿®æ”¹éœ€æ±‚ä½†æ²¡æœ‰å®é™…è°ƒç”¨å›¾ç‰‡ç”Ÿæˆ API  
**åˆ›å»ºæ—¶é—´**: 2025-11-09

---

## ğŸ” é—®é¢˜ç—‡çŠ¶

ç”¨æˆ·æŠ¥å‘Šï¼š
- âœ… ç³»ç»Ÿè¯†åˆ«äº†ç›®æ ‡å›¾ç‰‡
- âœ… ç”Ÿæˆäº†æ–°çš„ prompt
- âŒ ä½†æ²¡æœ‰å®é™…è°ƒç”¨å›¾ç‰‡ç”Ÿæˆ API
- âŒ å›¾ç‰‡æ²¡æœ‰è¢«é‡æ–°ç”Ÿæˆ

---

## ğŸ“Š è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥æ—¥å¿—è¾“å‡º

åœ¨ Bot è¿è¡Œæ—¶ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œå¯»æ‰¾ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š

#### åº”è¯¥çœ‹åˆ°çš„æ—¥å¿—åºåˆ—

```
[regenerate_single_image] å¼€å§‹é‡æ–°ç”Ÿæˆå•å¼ å›¾ç‰‡...
[regenerate_single_image] ç›®æ ‡å›¾ç‰‡: word_xxx
[regenerate_single_image] ä¿®æ”¹è¦æ±‚: xxx
[regenerate_single_image] æ–° prompt: xxx...
[regenerate_single_image] å¼€å§‹è°ƒç”¨ Gemini Image API é‡æ–°ç”Ÿæˆå›¾ç‰‡...  â† å…³é”®æ—¥å¿— 1
[regenerate_single_image] å‚æ•°: image_id=xxx, aspect_ratio=xxx
[regenerate_single_image] æ–° prompt å®Œæ•´å†…å®¹: xxx
[regenerate_single_image] API è°ƒç”¨å®Œæˆï¼Œç»“æœ: success=True  â† å…³é”®æ—¥å¿— 2
[regenerate_single_image] âœ“ å›¾ç‰‡é‡æ–°ç”ŸæˆæˆåŠŸ: word_xxx
```

#### å¯èƒ½çš„é—®é¢˜åœºæ™¯

**åœºæ™¯ A: æ‰¾ä¸åˆ°åŸå§‹éœ€æ±‚**
```
[regenerate_single_image] ç›®æ ‡å›¾ç‰‡: word_xxx
[regenerate_single_image] ä¿®æ”¹è¦æ±‚: xxx
[regenerate_single_image] æ–° prompt: xxx...
[regenerate_single_image] æ‰¾ä¸åˆ°ç›®æ ‡å›¾ç‰‡çš„åŸå§‹éœ€æ±‚: word_xxx  â† é”™è¯¯
[regenerate_single_image] å¯ç”¨çš„ image_requirements: ['word_aaa', 'word_bbb']
```

**åŸå› **: LLM è¯†åˆ«çš„ `target_image_id` ä¸å®é™…çš„ `image_requirements` ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**: 
- æ£€æŸ¥ LLM è¿”å›çš„ target_image_id æ˜¯å¦æ­£ç¡®
- å¯èƒ½éœ€è¦ä¼˜åŒ– LLM çš„åˆ†æ prompt

**åœºæ™¯ B: API è°ƒç”¨å¤±è´¥**
```
[regenerate_single_image] å¼€å§‹è°ƒç”¨ Gemini Image API é‡æ–°ç”Ÿæˆå›¾ç‰‡...
[regenerate_single_image] API è°ƒç”¨å®Œæˆï¼Œç»“æœ: success=False  â† å¤±è´¥
[regenerate_single_image] âœ— å›¾ç‰‡é‡æ–°ç”Ÿæˆå¤±è´¥: xxxé”™è¯¯
```

**åŸå› **: Gemini Image API è°ƒç”¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ API Key
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ£€æŸ¥ API é…é¢

**åœºæ™¯ C: ä»£ç å¼‚å¸¸**
```
[regenerate_single_image] å¤„ç†å¤±è´¥: xxx  â† å¼‚å¸¸
Traceback...
```

**åŸå› **: ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**: æ ¹æ®å¼‚å¸¸ä¿¡æ¯ä¿®å¤ä»£ç 

---

### æ­¥éª¤ 2: éªŒè¯çŠ¶æ€ä¼ é€’

æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

#### 2.1 æ£€æŸ¥ `image_requirements` æ˜¯å¦å­˜åœ¨

åœ¨ `regenerate_single_image` èŠ‚ç‚¹è¢«è°ƒç”¨æ—¶ï¼ŒçŠ¶æ€ä¸­åº”è¯¥æœ‰ `image_requirements`ã€‚

**éªŒè¯æ–¹æ³•**: æŸ¥çœ‹æ—¥å¿—ä¸­çš„ï¼š
```
[regenerate_single_image] å¯ç”¨çš„ image_requirements: [...]
```

å¦‚æœè¿™ä¸ªåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œè¯´æ˜çŠ¶æ€æ²¡æœ‰æ­£ç¡®ä¼ é€’ã€‚

#### 2.2 æ£€æŸ¥ `generated_images` æ˜¯å¦å­˜åœ¨

åº”è¯¥æœ‰å·²ç”Ÿæˆçš„å›¾ç‰‡åˆ—è¡¨ã€‚

**éªŒè¯æ–¹æ³•**: æŸ¥çœ‹æ—¥å¿—ï¼Œå¦‚æœçœ‹åˆ°ï¼š
```
[regenerate_single_image] æ²¡æœ‰å·²ç”Ÿæˆçš„å›¾ç‰‡ï¼Œè·³è¿‡
```

è¯´æ˜ `generated_images` ä¸ºç©ºæˆ–ä¸å­˜åœ¨ã€‚

#### 2.3 æ£€æŸ¥ `lesson_id` æ˜¯å¦å­˜åœ¨

åº”è¯¥æœ‰è¯¾ç¨‹ ID ç”¨äºç¡®å®šå›¾ç‰‡ä¿å­˜è·¯å¾„ã€‚

**éªŒè¯æ–¹æ³•**: æ£€æŸ¥æ—¥å¿—ä¸­çš„å‚æ•°è¾“å‡ºã€‚

---

### æ­¥éª¤ 3: æ‰‹åŠ¨æµ‹è¯•å›¾ç‰‡ç”Ÿæˆ

è¿è¡Œç®€å•çš„æµ‹è¯•è„šæœ¬éªŒè¯ API æ˜¯å¦æ­£å¸¸ï¼š

```bash
python _test_image_api.py
```

å¦‚æœè¿™ä¸ªæµ‹è¯•å¤±è´¥ï¼Œè¯´æ˜ Gemini Image API æœ¬èº«æœ‰é—®é¢˜ã€‚

---

## ğŸ”§ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: LLM è¯†åˆ«çš„å›¾ç‰‡ ID ä¸åŒ¹é…

**ç—‡çŠ¶**:
```
ç›®æ ‡å›¾ç‰‡: word_dog
å¯ç”¨çš„ image_requirements: ['word_dolphin', 'word_ocean', 'word_swim']
```

**åŸå› **: 
- LLM ç†è§£é”™è¯¯
- ç”¨æˆ·æè¿°ä¸å¤Ÿæ˜ç¡®

**è§£å†³æ–¹æ¡ˆ**:
1. ç”¨æˆ·ä½¿ç”¨æ›´æ˜ç¡®çš„æè¿°ï¼Œå¦‚ï¼š"dolphin è¿™ä¸ªå•è¯çš„å›¾ç‰‡æ”¹æˆè“è‰²"
2. ä¼˜åŒ– LLM çš„åˆ†æ promptï¼Œæä¾›æ›´å¤šä¸Šä¸‹æ–‡

### é—®é¢˜ 2: å›¾ç‰‡ ID å¤§å°å†™æˆ–æ ¼å¼é—®é¢˜

**ç—‡çŠ¶**:
```
ç›®æ ‡å›¾ç‰‡: Word_Dolphin  (é”™è¯¯æ ¼å¼)
å¯ç”¨çš„: word_dolphin   (æ­£ç¡®æ ¼å¼)
```

**åŸå› **: LLM è¿”å›çš„ ID æ ¼å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**: åœ¨ä»£ç ä¸­æ·»åŠ  ID æ ¼å¼æ ‡å‡†åŒ–

```python
target_id = parsed.get("target_image_id", "").lower().replace(" ", "_")
```

### é—®é¢˜ 3: çŠ¶æ€æ²¡æœ‰æ­£ç¡®æ›´æ–°

**ç—‡çŠ¶**: å›¾ç‰‡é‡æ–°ç”Ÿæˆäº†ï¼Œä½†ç½‘é¡µä¸­ä»ç„¶æ˜¯æ—§å›¾ç‰‡

**åŸå› **: `regenerate_single_image` è¿”å›çš„çŠ¶æ€æ²¡æœ‰è¢«åº”ç”¨

**éªŒè¯**:
1. æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦è¿”å›äº† `{"generated_images": updated_images}`
2. æ£€æŸ¥ä¸‹æ¸¸èŠ‚ç‚¹ï¼ˆgenerate_webpageï¼‰æ˜¯å¦æ”¶åˆ°äº†æ›´æ–°åçš„ generated_images

**è§£å†³æ–¹æ¡ˆ**: 
- ç¡®è®¤ graph çš„è¾¹é…ç½®æ­£ç¡®
- ç¡®è®¤çŠ¶æ€æ›´æ–°é€»è¾‘æ­£ç¡®

---

## ğŸ§ª å¢å¼ºçš„æµ‹è¯•æµç¨‹

### å®Œæ•´çš„æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨ Bot**
   ```bash
   python -m src.bot
   ```

2. **ç”Ÿæˆè¯¾ç¨‹**
   ```
   /start æµ·æ´‹åŠ¨ç‰©
   ```

3. **åŒæ„è¯¾ç¨‹**
   ```
   åŒæ„
   ```

4. **ç­‰å¾…å›¾ç‰‡å’Œç½‘é¡µç”Ÿæˆ** (çº¦ 50-70 ç§’)

5. **æäº¤å›¾ç‰‡ä¿®æ”¹è¯·æ±‚**
   ```
   dolphin è¿™ä¸ªå•è¯çš„å›¾ç‰‡èƒŒæ™¯æ”¹æˆæ·±è“è‰²
   ```
   
   æˆ–
   
   ```
   ç¬¬ä¸€å¼ å›¾ç‰‡çš„èƒŒæ™¯æ”¹æˆè“è‰²
   ```

6. **è§‚å¯Ÿæ—¥å¿—è¾“å‡º**
   - åº”è¯¥çœ‹åˆ°è¯†åˆ«ç›®æ ‡å›¾ç‰‡
   - åº”è¯¥çœ‹åˆ°è°ƒç”¨ API
   - åº”è¯¥çœ‹åˆ°ç”ŸæˆæˆåŠŸ
   - åº”è¯¥çœ‹åˆ°é‡æ–°ç”Ÿæˆç½‘é¡µ

7. **éªŒè¯ç»“æœ**
   - æ‰“å¼€æ–°çš„ç½‘é¡µé“¾æ¥
   - æ£€æŸ¥ç›®æ ‡å›¾ç‰‡æ˜¯å¦æ›´æ–°
   - æ£€æŸ¥å…¶ä»–å›¾ç‰‡æ˜¯å¦ä¿æŒä¸å˜

---

## ğŸ“ è°ƒè¯•æ¸…å•

ä½¿ç”¨ä»¥ä¸‹æ¸…å•é€é¡¹æ’æŸ¥ï¼š

- [ ] Bot æ­£å¸¸å¯åŠ¨ï¼Œæ²¡æœ‰é”™è¯¯
- [ ] è¯¾ç¨‹ç”ŸæˆæˆåŠŸ
- [ ] å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼ˆç¬¬ä¸€æ¬¡ï¼‰
- [ ] ç½‘é¡µç”ŸæˆæˆåŠŸï¼ˆç¬¬ä¸€æ¬¡ï¼‰
- [ ] æäº¤å›¾ç‰‡ä¿®æ”¹åé¦ˆ
- [ ] è·¯ç”±è¯†åˆ«ä¸ºå›¾ç‰‡ä¿®æ”¹ï¼ˆä¸æ˜¯ç½‘é¡µä¿®æ”¹ï¼‰
- [ ] è¿›å…¥ regenerate_single_image èŠ‚ç‚¹
- [ ] LLM æˆåŠŸè¯†åˆ«ç›®æ ‡å›¾ç‰‡
- [ ] æ‰¾åˆ°ç›®æ ‡å›¾ç‰‡çš„åŸå§‹éœ€æ±‚
- [ ] è°ƒç”¨ generate_image_with_gemini
- [ ] API è°ƒç”¨æˆåŠŸï¼Œå›¾ç‰‡ä¿å­˜
- [ ] æ›´æ–° generated_images çŠ¶æ€
- [ ] è¿›å…¥ generate_webpage èŠ‚ç‚¹
- [ ] ç½‘é¡µä½¿ç”¨æ–°çš„å›¾ç‰‡ä¿¡æ¯
- [ ] é‡æ–°éƒ¨ç½²ç½‘é¡µ
- [ ] ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ›´æ–°åçš„å›¾ç‰‡

---

## ğŸ” å…³é”®ä»£ç ä½ç½®

### regenerate_single_image èŠ‚ç‚¹
- **æ–‡ä»¶**: `src/nodes.py`
- **è¡Œå·**: 594-739
- **å…³é”®æ­¥éª¤**:
  - ç¬¬ 622-627 è¡Œ: LLM åˆå§‹åŒ–
  - ç¬¬ 673 è¡Œ: è°ƒç”¨ LLM åˆ†æ
  - ç¬¬ 685-687 è¡Œ: è§£æ target_id å’Œ new_prompt
  - ç¬¬ 698-701 è¡Œ: æŸ¥æ‰¾åŸå§‹éœ€æ±‚ï¼ˆå¯èƒ½å¤±è´¥ç‚¹ï¼‰
  - ç¬¬ 707-712 è¡Œ: è°ƒç”¨å›¾ç‰‡ç”Ÿæˆ APIï¼ˆå¯èƒ½å¤±è´¥ç‚¹ï¼‰
  - ç¬¬ 714-730 è¡Œ: æ›´æ–°çŠ¶æ€

### è·¯ç”±å‡½æ•°
- **æ–‡ä»¶**: `src/graph.py`
- **è¡Œå·**: 75-154
- **å…³é”®é€»è¾‘**: è¯†åˆ«å›¾ç‰‡å…³é”®è¯ â†’ è·¯ç”±åˆ° regenerate_single_image

### å›¾ç‰‡ç”Ÿæˆå·¥å…·
- **æ–‡ä»¶**: `src/tools.py`
- **è¡Œå·**: 66-166
- **å…³é”®åŠŸèƒ½**: è°ƒç”¨ Gemini Image API

---

## ğŸ’¡ å»ºè®®çš„æ”¹è¿›

### 1. æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—

å·²åœ¨ä»£ç ä¸­æ·»åŠ ï¼š
- API è°ƒç”¨å‰åçš„æ—¥å¿—
- å‚æ•°è¯¦æƒ…
- å®Œæ•´çš„ prompt å†…å®¹

### 2. æ·»åŠ  ID æ ‡å‡†åŒ–

å»ºè®®åœ¨ä»£ç ä¸­æ·»åŠ ï¼š
```python
target_id = target_id.lower().strip().replace(" ", "_")
```

### 3. æ·»åŠ é‡è¯•æœºåˆ¶

å¦‚æœ API è°ƒç”¨å¤±è´¥ï¼Œå¯ä»¥è‡ªåŠ¨é‡è¯•ï¼š
```python
max_retries = 3
for attempt in range(max_retries):
    result = generate_image_with_gemini(...)
    if result["success"]:
        break
    logger.warning(f"é‡è¯• {attempt + 1}/{max_retries}...")
```

### 4. æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º

åœ¨ Bot ä¸­å‘ç”¨æˆ·åé¦ˆå…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é™é»˜å¤±è´¥ã€‚

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å®Œæ•´çš„æ—¥å¿—è¾“å‡º**ï¼ˆä»æäº¤ä¿®æ”¹åé¦ˆå¼€å§‹ï¼‰
2. **ç”¨æˆ·çš„ä¿®æ”¹åé¦ˆå†…å®¹**
3. **å½“å‰çš„å›¾ç‰‡åˆ—è¡¨**ï¼ˆimage_requirements å’Œ generated_imagesï¼‰
4. **æ˜¯å¦çœ‹åˆ° API è°ƒç”¨çš„æ—¥å¿—**
5. **æ˜¯å¦æœ‰ä»»ä½•é”™è¯¯æˆ–è­¦å‘Šä¿¡æ¯**

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-09
